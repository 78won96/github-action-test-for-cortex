name: Build, Scan, Push to ECR and Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: github-action-test-for-cortex
  CORTEX_API_KEY: ${{ secrets.CORTEX_API_KEY }}
  CORTEX_API_KEY_ID: ${{ secrets.CORTEX_API_KEY_ID }}
  CORTEX_API_URL: https://api-u-infra-260126-xdr.xdr.sg.paloaltonetworks.com

jobs:
  build-scan-push:
    name: Build image, Cortex scan, Push to ECR
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build image
        run: docker build -t ${{ env.ECR_REPOSITORY }}:build .

      - name: "Set up Java (cortexcli 요구: Java 11 이상)"
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "11"

      - name: Install Cortex CLI dependencies (libhs.so.5)
        run: |
          sudo apt-get update
          sudo apt-get install -y libhyperscan5

      - name: Download Cortex CLI and scan image
        run: |
          set -x
          crtx_resp=$(curl -s "${{ env.CORTEX_API_URL }}/public_api/v1/unified-cli/releases/download-link?os=linux&architecture=amd64" -H "x-xdr-auth-id: ${{ env.CORTEX_API_KEY_ID }}" -H "Authorization: ${{ env.CORTEX_API_KEY }}")
          crtx_url=$(echo $crtx_resp | jq -r ".signed_url")
          crtx_file=$(echo $crtx_resp | jq -r ".file_name")
          curl -o "$crtx_file" "$crtx_url"
          chmod +x "$crtx_file"
          # 빌드된 Docker 이미지 스캔 (image scan <image name>)
          ./"$crtx_file" --api-base-url "${{ env.CORTEX_API_URL }}" --api-key "${{ env.CORTEX_API_KEY }}" --api-key-id "${{ env.CORTEX_API_KEY_ID }}" image scan ${{ env.ECR_REPOSITORY }}:build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Tag and push image to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ env.ECR_REPOSITORY }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker tag $ECR_REPOSITORY:build $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

  deploy:
    name: Deploy to EC2 (ECR image)
    needs: build-scan-push
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to EC2 via Docker (ECR 이미지 사용)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            ECR_REGISTRY="${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com"
            ECR_IMAGE="${ECR_REGISTRY}/${{ env.ECR_REPOSITORY }}:latest"
            CORTEX_API_URL="${{ env.CORTEX_API_URL }}"
            CORTEX_API_KEY="${{ secrets.CORTEX_API_KEY }}"
            CORTEX_API_KEY_ID="${{ secrets.CORTEX_API_KEY_ID }}"

            # 1. 기존 컨테이너 정리
            docker stop my-web-server || true
            docker rm my-web-server || true

            # 2. AWS CLI 설치 (ECR 로그인에 필요)
            sudo apt-get update -qq
            sudo apt-get install -y -qq awscli

            # 3. ECR 로그인 (EC2 인스턴스에 IAM 역할 또는 AWS 자격 증명 필요)
            aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${ECR_REGISTRY}

            # 4. ECR 이미지 Pull
            docker pull ${ECR_IMAGE}

            # 5. Cortex CLI 설치 후 Pull한 이미지 스캔 (Java 11+, libhyperscan5, jq 필요)
            sudo apt-get update -qq
            sudo apt-get install -y -qq openjdk-11-jre-headless libhyperscan5 jq 2>/dev/null || true
            crtx_resp=$(curl -s "${CORTEX_API_URL}/public_api/v1/unified-cli/releases/download-link?os=linux&architecture=amd64" -H "x-xdr-auth-id: ${CORTEX_API_KEY_ID}" -H "Authorization: ${CORTEX_API_KEY}")
            crtx_url=$(echo "$crtx_resp" | jq -r ".signed_url")
            crtx_file=$(echo "$crtx_resp" | jq -r ".file_name")
            curl -s -o "$crtx_file" "$crtx_url"
            chmod +x "$crtx_file"
            ./"$crtx_file" --api-base-url "$CORTEX_API_URL" --api-key "$CORTEX_API_KEY" --api-key-id "$CORTEX_API_KEY_ID" image scan ${ECR_IMAGE}

            # 6. 컨테이너 실행
            docker run -d --name my-web-server -p 80:80 ${ECR_IMAGE}
